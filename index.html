import React, { useState, useEffect, createContext, useContext, useMemo } from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line } from 'recharts';
import { initializeApp } from 'firebase/app';
import { getAuth, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, getDocs, onSnapshot, doc, updateDoc, deleteDoc, query, where, setDoc, getDoc } from 'firebase/firestore';
import { Home, Package, ShoppingCart, Users, BarChart2, DollarSign, List, Calendar, Settings, LogOut, Moon, Sun, Menu, X } from 'lucide-react';

// --- FIREBASE CONFIG (Netlify & Local Ready) ---
let firebaseConfig;

// This logic checks if the code is running in a build environment (like Netlify) 
// where 'process' is defined. If not, it falls back to the local/preview config to avoid errors.
if (typeof process !== 'undefined' && process.env.REACT_APP_API_KEY) {
  firebaseConfig = {
    apiKey: process.env.REACT_APP_API_KEY,
    authDomain: process.env.REACT_APP_AUTH_DOMAIN,
    projectId: process.env.REACT_APP_PROJECT_ID,
    storageBucket: process.env.REACT_APP_STORAGE_BUCKET,
    messagingSenderId: process.env.REACT_APP_MESSAGING_SENDER_ID,
    appId: process.env.REACT_APP_APP_ID
  };
} else {
  firebaseConfig = typeof __firebase_config !== 'undefined' 
    ? JSON.parse(__firebase_config)
    : {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
      };
}


// --- APP INITIALIZATION ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- APP ID ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'rahimi-mobile-manager';

// --- TRANSLATION DATA ---
const translations = {
  en: {
    // General
    dashboard: 'Dashboard',
    products: 'Products',
    sales: 'Sales',
    expenses: 'Expenses',
    customers: 'Customers',
    stock: 'Stock/Inventory',
    reports: 'Reports',
    tasks: 'Tasks & Reminders',
    settings: 'Settings',
    logout: 'Logout',
    rahimiMobileManager: 'Rahimi Mobile Manager',
    // Dashboard
    dailyOverview: 'Daily Overview',
    salesToday: 'Sales Today',
    profitToday: 'Profit Today',
    expensesToday: 'Expenses Today',
    topSellingProducts: 'Top Selling Products',
    lowStockAlerts: 'Low Stock Alerts',
    // Products
    manageProducts: 'Manage Products',
    addProduct: 'Add Product',
    productName: 'Product Name',
    purchasePrice: 'Purchase Price',
    sellingPrice: 'Selling Price',
    quantity: 'Quantity',
    category: 'Category',
    actions: 'Actions',
    edit: 'Edit',
    delete: 'Delete',
    save: 'Save',
    cancel: 'Cancel',
    // Sales
    newSale: 'New Sale',
    searchProducts: 'Search products...',
    invoice: 'Invoice',
    qty: 'Qty',
    price: 'Price',
    total: 'Total',
    subtotal: 'Subtotal',
    discount: 'Discount',
    tax: 'Tax',
    grandTotal: 'Grand Total',
    completeSale: 'Complete Sale',
  },
  ps: {
    // General
    dashboard: 'ډشبورډ',
    products: 'محصولات',
    sales: 'پلورنې',
    expenses: 'لګښتونه',
    customers: 'پیرودونکي',
    stock: 'ګدام',
    reports: 'راپورونه',
    tasks: 'دندې او یادونې',
    settings: 'ترتیبات',
    logout: 'وتل',
    rahimiMobileManager: 'رحیمي موبایل مدیر',
    // Dashboard
    dailyOverview: 'ورځنی کتنه',
    salesToday: 'نننۍ پلورنې',
    profitToday: 'نننۍ ګټه',
    expensesToday: 'ننني لګښتونه',
    topSellingProducts: 'غوره پلورل شوي محصولات',
    lowStockAlerts: 'د کم মজودۍ خبرتیا',
    // Products
    manageProducts: 'د محصولاتو مدیریت',
    addProduct: 'نوی محصول اضافه کړئ',
    productName: 'د محصول نوم',
    purchasePrice: 'د پیرودلو بیه',
    sellingPrice: 'د پلورلو بیه',
    quantity: 'مقدار',
    category: 'وېشنيزه',
    actions: 'کړنې',
    edit: 'سمول',
    delete: 'ړنګول',
    save: 'خوندي کول',
    cancel: 'لغوه کول',
    // Sales
    newSale: 'نوی پلور',
    searchProducts: 'محصولات وپلټئ...',
    invoice: 'بیل',
    qty: 'مقدار',
    price: 'بیه',
    total: 'ټول',
    subtotal: 'فرعي ټول',
    discount: 'تخفیف',
    tax: 'مالیه',
    grandTotal: 'لوی ټول',
    completeSale: 'پلور بشپړ کړئ',
  },
};

// --- CONTEXTS ---
const AuthContext = createContext(null);
const LanguageContext = createContext(null);
const ThemeContext = createContext(null);

// --- HOOKS ---
const useAuth = () => useContext(AuthContext);
const useLanguage = () => {
    const context = useContext(LanguageContext);
    if (!context) {
        throw new Error("useLanguage must be used within a LanguageProvider");
    }
    const { language, setLanguage, t } = context;
    return { language, setLanguage, t };
};
const useTheme = () => useContext(ThemeContext);

// --- PROVIDERS ---
const AuthProvider = ({ children }) => {
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    const [userId, setUserId] = useState(null);

    useEffect(() => {
        const performAuth = async () => {
            try {
                // Automatically sign in the user.
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Automatic Authentication Error:", error);
                setLoading(false);
            }
        };

        const unsubscribe = onAuthStateChanged(auth, (authUser) => {
            if (authUser) {
                // User is signed in (anonymously or with token).
                // Create a mock user object for the app to use.
                const currentUser = { uid: authUser.uid, email: 'user@shop.com', role: 'Admin' };
                setUser(currentUser);
                setUserId(authUser.uid);
            } else {
                // This case should not be hit with the current logic.
                setUser(null);
                setUserId(null);
            }
            setLoading(false);
        });

        performAuth();

        return () => unsubscribe();
    }, []);

    const value = { user, loading, userId };
    return <AuthContext.Provider value={value}>{!loading && children}</AuthContext.Provider>;
};

const LanguageProvider = ({ children }) => {
    const [language, setLanguage] = useState('en');
    const t = (key) => translations[language][key] || key;
    return (
        <LanguageContext.Provider value={{ language, setLanguage, t }}>
            {children}
        </LanguageContext.Provider>
    );
};

const ThemeProvider = ({ children }) => {
    const [theme, setTheme] = useState('light');
    const toggleTheme = () => {
        setTheme(prevTheme => (prevTheme === 'light' ? 'dark' : 'light'));
    };

    useEffect(() => {
        const root = window.document.documentElement;
        root.classList.remove(theme === 'light' ? 'dark' : 'light');
        root.classList.add(theme);
    }, [theme]);

    return (
        <ThemeContext.Provider value={{ theme, toggleTheme }}>
            {children}
        </ThemeContext.Provider>
    );
};

// --- COMPONENTS ---

const Sidebar = ({ activePage, setActivePage, isSidebarOpen }) => {
    const { t } = useLanguage();
    const navItems = [
        { id: 'dashboard', label: t('dashboard'), icon: Home },
        { id: 'products', label: t('products'), icon: Package },
        { id: 'sales', label: t('sales'), icon: ShoppingCart },
        { id: 'expenses', label: t('expenses'), icon: DollarSign },
        { id: 'customers', label: t('customers'), icon: Users },
        { id: 'stock', label: t('stock'), icon: List },
        { id: 'reports', label: t('reports'), icon: BarChart2 },
        { id: 'tasks', label: t('tasks'), icon: Calendar },
    ];

    return (
        <aside className={`bg-white dark:bg-gray-800 text-gray-900 dark:text-white flex flex-col transition-all duration-300 ${isSidebarOpen ? 'w-64' : 'w-20'}`}>
            <div className={`flex items-center justify-center h-20 border-b border-gray-200 dark:border-gray-700 ${isSidebarOpen ? 'px-4' : ''}`}>
                <ShoppingCart className="w-8 h-8 text-indigo-500" />
                {isSidebarOpen && <h1 className="ml-3 text-xl font-bold">{t('rahimiMobileManager')}</h1>}
            </div>
            <nav className="flex-1 px-2 py-4 space-y-2">
                {navItems.map(item => (
                    <a
                        key={item.id}
                        href="#"
                        onClick={(e) => { e.preventDefault(); setActivePage(item.id); }}
                        className={`flex items-center p-3 text-base font-normal rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 group ${activePage === item.id ? 'bg-gray-200 dark:bg-gray-700' : ''}`}
                    >
                        <item.icon className="w-6 h-6 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" />
                        {isSidebarOpen && <span className="ml-3 flex-1 whitespace-nowrap">{item.label}</span>}
                    </a>
                ))}
            </nav>
        </aside>
    );
};

const Header = ({ toggleSidebar, isSidebarOpen, toggleMobileSidebar }) => {
    const { language, setLanguage } = useLanguage();
    const { theme, toggleTheme } = useTheme();

    return (
        <header className="flex items-center justify-between h-20 px-6 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
            <div className="flex items-center">
                 <button onClick={toggleMobileSidebar} className="p-2 -ml-2 text-gray-600 rounded-md md:hidden dark:text-gray-300">
                    <Menu size={24} />
                </button>
                <button onClick={toggleSidebar} className="hidden p-2 -ml-2 text-gray-600 rounded-md md:block dark:text-gray-300">
                    <Menu size={24} />
                </button>
            </div>
            <div className="flex items-center space-x-4">
                <button onClick={toggleTheme} className="p-2 text-gray-600 rounded-full hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700">
                    {theme === 'light' ? <Moon size={20} /> : <Sun size={20} />}
                </button>
                <select
                    value={language}
                    onChange={(e) => setLanguage(e.target.value)}
                    className="px-3 py-2 text-sm bg-gray-100 border-gray-300 rounded-md dark:bg-gray-700 dark:text-white dark:border-gray-600 focus:outline-none"
                >
                    <option value="en">English</option>
                    <option value="ps">پښتو</option>
                </select>
            </div>
        </header>
    );
};

const Dashboard = () => {
    const { t } = useLanguage();
    const { userId } = useAuth();
    const [sales, setSales] = useState([]);
    const [products, setProducts] = useState([]);
    const [expenses, setExpenses] = useState([]);

    useEffect(() => {
        if (!userId) return;
        const salesPath = `/artifacts/${appId}/users/${userId}/sales`;
        const productsPath = `/artifacts/${appId}/users/${userId}/products`;
        const expensesPath = `/artifacts/${appId}/users/${userId}/expenses`;

        const salesUnsub = onSnapshot(collection(db, salesPath), (snapshot) => {
            setSales(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
        const productsUnsub = onSnapshot(collection(db, productsPath), (snapshot) => {
            setProducts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
        const expensesUnsub = onSnapshot(collection(db, expensesPath), (snapshot) => {
            setExpenses(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });

        return () => {
            salesUnsub();
            productsUnsub();
            expensesUnsub();
        };
    }, [userId]);

    const today = new Date().toISOString().split('T')[0];
    
    const salesToday = useMemo(() => sales.filter(s => s.date?.toDate().toISOString().split('T')[0] === today), [sales, today]);
    const expensesToday = useMemo(() => expenses.filter(e => e.date?.toDate().toISOString().split('T')[0] === today), [expenses, today]);
    
    const totalSalesToday = useMemo(() => salesToday.reduce((sum, s) => sum + s.grandTotal, 0), [salesToday]);
    const totalExpensesToday = useMemo(() => expensesToday.reduce((sum, e) => sum + e.amount, 0), [expensesToday]);
    
    const totalCostToday = useMemo(() => {
        return salesToday.reduce((cost, sale) => {
            const saleCost = sale.items.reduce((itemCost, item) => {
                const product = products.find(p => p.id === item.productId);
                return itemCost + (product ? product.purchasePrice * item.quantity : 0);
            }, 0);
            return cost + saleCost;
        }, 0);
    }, [salesToday, products]);

    const profitToday = totalSalesToday - totalCostToday;
    
    const topSellingProducts = useMemo(() => {
        const productSales = {};
        sales.forEach(sale => {
            sale.items.forEach(item => {
                productSales[item.productId] = (productSales[item.productId] || 0) + item.quantity;
            });
        });
        
        return Object.entries(productSales)
            .sort(([, qtyA], [, qtyB]) => qtyB - qtyA)
            .slice(0, 5)
            .map(([productId, quantity]) => {
                const product = products.find(p => p.id === productId);
                return { name: product ? product.name : 'Unknown', quantity };
            });
    }, [sales, products]);

    const lowStockProducts = useMemo(() => products.filter(p => p.quantity <= (p.lowStockLevel || 5)), [products]);

    const salesData = useMemo(() => {
         const last7Days = Array.from({length: 7}, (_, i) => {
            const d = new Date();
            d.setDate(d.getDate() - i);
            return d.toISOString().split('T')[0];
        }).reverse();

        return last7Days.map(date => {
            const dailySales = sales
                .filter(s => s.date?.toDate().toISOString().split('T')[0] === date)
                .reduce((sum, s) => sum + s.grandTotal, 0);
            return { name: new Date(date).toLocaleDateString('en-US', { weekday: 'short'}), sales: dailySales };
        });
    }, [sales]);


    return (
        <div className="p-6 space-y-6">
            <h2 className="text-3xl font-bold text-gray-800 dark:text-white">{t('dashboard')}</h2>
            <div className="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
                <div className="p-6 bg-white rounded-lg shadow dark:bg-gray-800">
                    <h3 className="text-lg font-medium text-gray-500 dark:text-gray-400">{t('salesToday')}</h3>
                    <p className="text-3xl font-bold text-gray-900 dark:text-white">${totalSalesToday.toFixed(2)}</p>
                </div>
                <div className="p-6 bg-white rounded-lg shadow dark:bg-gray-800">
                    <h3 className="text-lg font-medium text-gray-500 dark:text-gray-400">{t('profitToday')}</h3>
                    <p className={`text-3xl font-bold ${profitToday >= 0 ? 'text-green-500' : 'text-red-500'}`}>${profitToday.toFixed(2)}</p>
                </div>
                <div className="p-6 bg-white rounded-lg shadow dark:bg-gray-800">
                    <h3 className="text-lg font-medium text-gray-500 dark:text-gray-400">{t('expensesToday')}</h3>
                    <p className="text-3xl font-bold text-gray-900 dark:text-white">${totalExpensesToday.toFixed(2)}</p>
                </div>
            </div>

            <div className="p-6 bg-white rounded-lg shadow dark:bg-gray-800">
                <h3 className="mb-4 text-xl font-semibold text-gray-800 dark:text-white">Sales Overview (Last 7 Days)</h3>
                <ResponsiveContainer width="100%" height={300}>
                    <BarChart data={salesData}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis dataKey="name" />
                        <YAxis />
                        <Tooltip contentStyle={{ backgroundColor: 'rgba(31, 41, 55, 0.8)', border: 'none' }}/>
                        <Legend />
                        <Bar dataKey="sales" fill="#4f46e5" />
                    </BarChart>
                </ResponsiveContainer>
            </div>

            <div className="grid grid-cols-1 gap-6 lg:grid-cols-2">
                <div className="p-6 bg-white rounded-lg shadow dark:bg-gray-800">
                    <h3 className="mb-4 text-xl font-semibold text-gray-800 dark:text-white">{t('topSellingProducts')}</h3>
                    <ul className="space-y-2">
                        {topSellingProducts.map((p, i) => (
                            <li key={i} className="flex justify-between p-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700">
                                <span className="text-gray-700 dark:text-gray-300">{p.name}</span>
                                <span className="font-semibold text-gray-900 dark:text-white">{p.quantity} sold</span>
                            </li>
                        ))}
                    </ul>
                </div>
                <div className="p-6 bg-white rounded-lg shadow dark:bg-gray-800">
                    <h3 className="mb-4 text-xl font-semibold text-gray-800 dark:text-white">{t('lowStockAlerts')}</h3>
                     <ul className="space-y-2">
                        {lowStockProducts.length > 0 ? lowStockProducts.map(p => (
                            <li key={p.id} className="flex justify-between p-2 text-yellow-600 bg-yellow-100 rounded dark:bg-yellow-900/20 dark:text-yellow-400">
                                <span >{p.name}</span>
                                <span className="font-semibold">Only {p.quantity} left</span>
                            </li>
                        )) : <p className="text-gray-500 dark:text-gray-400">No low stock items.</p>}
                    </ul>
                </div>
            </div>
        </div>
    );
};

const Products = () => {
    const { t } = useLanguage();
    const { userId } = useAuth();
    const [products, setProducts] = useState([]);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [editingProduct, setEditingProduct] = useState(null);
    const [formData, setFormData] = useState({ name: '', purchasePrice: '', sellingPrice: '', quantity: '', category: '' });

    const productsPath = useMemo(() => `/artifacts/${appId}/users/${userId}/products`, [userId]);

    useEffect(() => {
        if (!userId) return;
        const q = query(collection(db, productsPath));
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const productsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setProducts(productsData);
        });
        return () => unsubscribe();
    }, [userId, productsPath]);

    const handleOpenModal = (product = null) => {
        setEditingProduct(product);
        setFormData(product ? { ...product } : { name: '', purchasePrice: '', sellingPrice: '', quantity: '', category: 'Mobiles' });
        setIsModalOpen(true);
    };

    const handleCloseModal = () => {
        setIsModalOpen(false);
        setEditingProduct(null);
    };

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        const productData = {
            ...formData,
            purchasePrice: parseFloat(formData.purchasePrice),
            sellingPrice: parseFloat(formData.sellingPrice),
            quantity: parseInt(formData.quantity, 10),
        };

        try {
            if (editingProduct) {
                const docRef = doc(db, productsPath, editingProduct.id);
                await updateDoc(docRef, productData);
            } else {
                await addDoc(collection(db, productsPath), { ...productData, createdAt: new Date() });
            }
            handleCloseModal();
        } catch (error) {
            console.error("Error saving product:", error);
        }
    };

    const handleDelete = async (id) => {
        // A simple confirmation dialog. For a better UX, use a custom modal component.
        if (window.confirm('Are you sure you want to delete this product?')) {
            try {
                await deleteDoc(doc(db, productsPath, id));
            } catch (error) {
                console.error("Error deleting product:", error);
            }
        }
    };
    
    const categories = ["Mobiles", "Chargers", "Memory Cards", "Cables", "Power Banks", "Software Services"];

    return (
        <div className="p-6">
            <div className="flex items-center justify-between mb-6">
                <h2 className="text-3xl font-bold text-gray-800 dark:text-white">{t('manageProducts')}</h2>
                <button onClick={() => handleOpenModal()} className="px-4 py-2 font-bold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">
                    {t('addProduct')}
                </button>
            </div>

            <div className="overflow-x-auto bg-white rounded-lg shadow dark:bg-gray-800">
                <table className="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                    <thead className="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                        <tr>
                            <th scope="col" className="px-6 py-3">{t('productName')}</th>
                            <th scope="col" className="px-6 py-3">{t('category')}</th>
                            <th scope="col" className="px-6 py-3">{t('purchasePrice')}</th>
                            <th scope="col" className="px-6 py-3">{t('sellingPrice')}</th>
                            <th scope="col" className="px-6 py-3">{t('quantity')}</th>
                            <th scope="col" className="px-6 py-3">{t('actions')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {products.map(product => (
                            <tr key={product.id} className="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                <td className="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">{product.name}</td>
                                <td className="px-6 py-4">{product.category}</td>
                                <td className="px-6 py-4">${product.purchasePrice?.toFixed(2)}</td>
                                <td className="px-6 py-4">${product.sellingPrice?.toFixed(2)}</td>
                                <td className="px-6 py-4">{product.quantity}</td>
                                <td className="px-6 py-4 space-x-2">
                                    <button onClick={() => handleOpenModal(product)} className="font-medium text-indigo-600 dark:text-indigo-500 hover:underline">{t('edit')}</button>
                                    <button onClick={() => handleDelete(product.id)} className="font-medium text-red-600 dark:text-red-500 hover:underline">{t('delete')}</button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {isModalOpen && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
                    <div className="w-full max-w-lg p-6 bg-white rounded-lg shadow-xl dark:bg-gray-800">
                        <h3 className="mb-4 text-xl font-semibold">{editingProduct ? 'Edit Product' : t('addProduct')}</h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                             <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">{t('productName')}</label>
                                <input type="text" name="name" value={formData.name} onChange={handleChange} required className="w-full mt-1 input-style" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">{t('category')}</label>
                                <select name="category" value={formData.category} onChange={handleChange} required className="w-full mt-1 input-style">
                                    {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                </select>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">{t('purchasePrice')}</label>
                                    <input type="number" name="purchasePrice" value={formData.purchasePrice} onChange={handleChange} required className="w-full mt-1 input-style" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">{t('sellingPrice')}</label>
                                    <input type="number" name="sellingPrice" value={formData.sellingPrice} onChange={handleChange} required className="w-full mt-1 input-style" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">{t('quantity')}</label>
                                <input type="number" name="quantity" value={formData.quantity} onChange={handleChange} required className="w-full mt-1 input-style" />
                            </div>
                            <div className="flex justify-end space-x-3">
                                <button type="button" onClick={handleCloseModal} className="px-4 py-2 bg-gray-200 rounded-lg dark:bg-gray-600">{t('cancel')}</button>
                                <button type="submit" className="px-4 py-2 text-white bg-indigo-600 rounded-lg">{t('save')}</button>
                            </div>
                        </form>
                    </div>
                </div>
            )}
        </div>
    );
};

const Sales = () => {
    const { t } = useLanguage();
    const { userId } = useAuth();
    const [products, setProducts] = useState([]);
    const [cart, setCart] = useState([]);
    const [searchTerm, setSearchTerm] = useState('');
    const [discount, setDiscount] = useState(0);
    const [tax, setTax] = useState(0); // Example: 10% tax

    const productsPath = useMemo(() => `/artifacts/${appId}/users/${userId}/products`, [userId]);
    const salesPath = useMemo(() => `/artifacts/${appId}/users/${userId}/sales`, [userId]);

    useEffect(() => {
        if (!userId) return;
        const unsubscribe = onSnapshot(collection(db, productsPath), (snapshot) => {
            setProducts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
        return () => unsubscribe();
    }, [userId, productsPath]);

    const addToCart = (product) => {
        setCart(prevCart => {
            const existingItem = prevCart.find(item => item.productId === product.id);
            if (existingItem) {
                return prevCart.map(item =>
                    item.productId === product.id ? { ...item, quantity: item.quantity + 1 } : item
                );
            }
            return [...prevCart, { productId: product.id, name: product.name, price: product.sellingPrice, quantity: 1 }];
        });
    };

    const updateQuantity = (productId, newQuantity) => {
        setCart(prevCart =>
            prevCart.map(item =>
                item.productId === productId ? { ...item, quantity: Math.max(1, newQuantity) } : item
            ).filter(item => item.quantity > 0)
        );
    };

    const removeFromCart = (productId) => {
        setCart(prevCart => prevCart.filter(item => item.productId !== productId));
    };

    const filteredProducts = products.filter(p =>
        p.name.toLowerCase().includes(searchTerm.toLowerCase()) && p.quantity > 0
    );

    const subtotal = useMemo(() => cart.reduce((sum, item) => sum + item.price * item.quantity, 0), [cart]);
    const grandTotal = useMemo(() => subtotal - discount + (subtotal * tax / 100), [subtotal, discount, tax]);

    const completeSale = async () => {
        if (cart.length === 0) return;
        const saleData = {
            items: cart,
            subtotal,
            discount,
            tax,
            grandTotal,
            date: new Date(),
        };

        try {
            await addDoc(collection(db, salesPath), saleData);

            // Update stock
            for (const item of cart) {
                const productRef = doc(db, productsPath, item.productId);
                const productSnap = await getDoc(productRef);
                if (productSnap.exists()) {
                    const currentQuantity = productSnap.data().quantity;
                    await updateDoc(productRef, {
                        quantity: currentQuantity - item.quantity,
                    });
                }
            }
            
            // Reset state
            setCart([]);
            setDiscount(0);
            setSearchTerm('');
            // A simple alert. For a better UX, use a custom modal/toast notification.
            window.alert('Sale completed successfully!');

        } catch (error) {
            console.error("Error completing sale:", error);
            window.alert('Failed to complete sale.');
        }
    };

    return (
        <div className="grid h-full grid-cols-1 gap-6 p-6 lg:grid-cols-3">
            {/* Product Selection */}
            <div className="lg:col-span-2">
                <div className="p-6 bg-white rounded-lg shadow dark:bg-gray-800">
                    <h3 className="mb-4 text-xl font-semibold">{t('newSale')}</h3>
                    <input
                        type="text"
                        placeholder={t('searchProducts')}
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="w-full mb-4 input-style"
                    />
                    <div className="grid grid-cols-2 gap-4 overflow-y-auto md:grid-cols-3 lg:grid-cols-4 max-h-96">
                        {filteredProducts.map(product => (
                            <div key={product.id} onClick={() => addToCart(product)} className="p-4 text-center bg-gray-100 rounded-lg cursor-pointer dark:bg-gray-700 hover:bg-indigo-100 dark:hover:bg-indigo-900">
                                <p className="font-semibold text-gray-800 dark:text-white">{product.name}</p>
                                <p className="text-sm text-gray-600 dark:text-gray-400">${product.sellingPrice.toFixed(2)}</p>
                            </div>
                        ))}
                    </div>
                </div>
            </div>

            {/* Invoice */}
            <div className="lg:col-span-1">
                <div className="p-6 bg-white rounded-lg shadow dark:bg-gray-800">
                    <h3 className="mb-4 text-xl font-semibold">{t('invoice')}</h3>
                    <div className="space-y-2 overflow-y-auto max-h-60">
                        {cart.length === 0 ? <p className="text-gray-500">Cart is empty</p> :
                         cart.map(item => (
                            <div key={item.productId} className="flex items-center justify-between">
                                <div>
                                    <p className="font-medium text-gray-800 dark:text-white">{item.name}</p>
                                    <p className="text-sm text-gray-500">${item.price.toFixed(2)}</p>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <input
                                        type="number"
                                        value={item.quantity}
                                        onChange={(e) => updateQuantity(item.productId, parseInt(e.target.value))}
                                        className="w-16 text-center input-style"
                                    />
                                    <button onClick={() => removeFromCart(item.productId)} className="text-red-500 hover:text-red-700">
                                        <X size={16} />
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="pt-4 mt-4 border-t border-gray-200 dark:border-gray-700">
                        <div className="flex justify-between mb-2"><span>{t('subtotal')}</span><span>${subtotal.toFixed(2)}</span></div>
                        <div className="flex items-center justify-between mb-2">
                            <span>{t('discount')} ($)</span>
                            <input type="number" value={discount} onChange={e => setDiscount(parseFloat(e.target.value) || 0)} className="w-24 text-right input-style" />
                        </div>
                         <div className="flex items-center justify-between mb-2">
                            <span>{t('tax')} (%)</span>
                            <input type="number" value={tax} onChange={e => setTax(parseFloat(e.target.value) || 0)} className="w-24 text-right input-style" />
                        </div>
                        <div className="flex justify-between text-xl font-bold"><span>{t('grandTotal')}</span><span>${grandTotal.toFixed(2)}</span></div>
                    </div>
                    <button onClick={completeSale} disabled={cart.length === 0} className="w-full px-4 py-3 mt-6 font-bold text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:bg-gray-400">
                        {t('completeSale')}
                    </button>
                </div>
            </div>
        </div>
    );
};

const PlaceholderPage = ({ title }) => (
    <div className="flex items-center justify-center h-full p-6">
        <div className="text-center">
            <h2 className="text-3xl font-bold text-gray-800 dark:text-white">{title}</h2>
            <p className="mt-2 text-gray-500 dark:text-gray-400">This feature is under construction.</p>
        </div>
    </div>
);


// --- MAIN APP COMPONENT ---
export default function App() {
    return (
        <ThemeProvider>
            <LanguageProvider>
                <AuthProvider>
                    <MainApp />
                </AuthProvider>
            </LanguageProvider>
        </ThemeProvider>
    );
}

const MainApp = () => {
    const { loading } = useAuth();
    const [activePage, setActivePage] = useState('dashboard');
    const [isSidebarOpen, setIsSidebarOpen] = useState(true);
    const [isMobileSidebarOpen, setIsMobileSidebarOpen] = useState(false);

    const toggleSidebar = () => setIsSidebarOpen(!isSidebarOpen);
    const toggleMobileSidebar = () => setIsMobileSidebarOpen(!isMobileSidebarOpen);

    const renderPage = () => {
        switch (activePage) {
            case 'dashboard': return <Dashboard />;
            case 'products': return <Products />;
            case 'sales': return <Sales />;
            case 'expenses': return <PlaceholderPage title="Expenses" />;
            case 'customers': return <PlaceholderPage title="Customers" />;
            case 'stock': return <PlaceholderPage title="Stock/Inventory" />;
            case 'reports': return <PlaceholderPage title="Reports" />;
            case 'tasks': return <PlaceholderPage title="Tasks & Reminders" />;
            default: return <Dashboard />;
        }
    };

    if (loading) {
        return <div className="flex items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900">Loading...</div>;
    }

    return (
        <div className="flex h-screen bg-gray-100 dark:bg-gray-900">
            {/* Desktop Sidebar */}
            <div className="hidden md:flex">
                 <Sidebar activePage={activePage} setActivePage={setActivePage} isSidebarOpen={isSidebarOpen} />
            </div>

            {/* Mobile Sidebar Overlay */}
            {isMobileSidebarOpen && (
                 <div className="fixed inset-0 z-30 bg-black opacity-50 md:hidden" onClick={toggleMobileSidebar}></div>
            )}
            
            {/* Mobile Sidebar */}
            <div className={`fixed inset-y-0 left-0 z-40 flex md:hidden transform ${isMobileSidebarOpen ? 'translate-x-0' : '-translate-x-full'} transition-transform duration-300 ease-in-out`}>
                <Sidebar activePage={activePage} setActivePage={(page) => {setActivePage(page); setIsMobileSidebarOpen(false);}} isSidebarOpen={true} />
            </div>


            <div className="flex flex-col flex-1 overflow-hidden">
                <Header 
                    toggleSidebar={toggleSidebar} 
                    isSidebarOpen={isSidebarOpen} 
                    toggleMobileSidebar={toggleMobileSidebar} 
                />
                <main className="flex-1 overflow-x-hidden overflow-y-auto">
                    {renderPage()}
                </main>
            </div>
        </div>
    );
};
