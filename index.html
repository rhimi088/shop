import React, { useState, useEffect, useRef, createContext, useContext } from 'react';

// --- ICONS (Lucide React SVGs) ---
// To keep this self-contained, icons are included as components.
// In a real app, you'd use a library like `lucide-react`.

const HomeIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></svg>
);
const PackageIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M16.5 9.4a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0Z" /><path d="M19 13.3a9 9 0 1 1-14 0" /><path d="M12 17.5a2.5 2.5 0 0 1 0-5 2.5 2.5 0 0 1 0 5Z" /></svg>
);
const ShoppingCartIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="8" cy="21" r="1" /><circle cx="19" cy="21" r="1" /><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.16" /></svg>
);
const UsersIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg>
);
const TruckIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M5 18H3c-.6 0-1-.4-1-1V7c0-.6.4-1 1-1h10c.6 0 1 .4 1 1v11" /><path d="M14 9h4l4 4v4c0 .6-.4 1-1 1h-2" /><circle cx="7" cy="18" r="2" /><path d="M15 18H9" /><circle cx="17" cy="18" r="2" /></svg>
);
const WrenchIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" /></svg>
);
const BarChartIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="12" x2="12" y1="20" y2="10" /><line x1="18" x2="18" y1="20" y2="4" /><line x1="6" x2="6" y1="20" y2="16" /></svg>
);
const SettingsIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></svg>
);
const SearchIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></svg>
);
const PlusCircleIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="16" /><line x1="8" x2="16" y1="12" y2="12" /></svg>
);
const ChevronDownIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m6 9 6 6 6-6" /></svg>
);
const BellIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" /><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" /></svg>
);
const QrCodeIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="5" height="5" x="3" y="3" rx="1" /><rect width="5" height="5" x="16" y="3" rx="1" /><rect width="5" height="5" x="3" y="16" rx="1" /><path d="M21 16h-3a2 2 0 0 0-2 2v3" /><path d="M21 21v.01" /><path d="M12 7v3a2 2 0 0 1-2 2H7" /><path d="M3 12h.01" /><path d="M12 3h.01" /><path d="M12 16v.01" /><path d="M16 12h.01" /><path d="M21 12h.01" /><path d="M12 21v-1a2 2 0 0 1 2-2h1" /></svg>
);
const Trash2Icon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" /><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></svg>
);
const DollarSignIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="12" x2="12" y1="2" y2="22" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></svg>
);
const AlertTriangleIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
);

// --- MOCK DATA ---
// This simulates your Supabase database for a runnable prototype.

const MOCK_USER = {
  name: 'Alex Chen',
  role: 'Owner',
  avatarUrl: 'https://placehold.co/100x100/E2E8F0/4A5568?text=AC'
};

const INITIAL_MOCK_PRODUCTS = [
  { id: 1, sku: 'APL-IP15P-256', name: 'iPhone 15 Pro - 256GB', category: 'Smartphones', brand: 'Apple', cost: 850.00, price: 1099.00, quantity: 8, has_imei: true },
  { id: 2, sku: 'SAM-GS24U-256', name: 'Galaxy S24 Ultra - 256GB', category: 'Smartphones', brand: 'Samsung', cost: 900.00, price: 1199.00, quantity: 3, has_imei: true },
  { id: 3, sku: 'ANK-PC10K', name: 'Anker PowerCore 10000', category: 'Accessories', brand: 'Anker', cost: 25.00, price: 49.99, quantity: 22, has_imei: false },
  { id: 4, sku: 'SPG-CS-IP15P', name: 'Spigen Case for iPhone 15 Pro', category: 'Accessories', brand: 'Spigen', cost: 15.00, price: 34.99, quantity: 15, has_imei: false },
  { id: 5, sku: 'REP-SCR-IP15P', name: 'iPhone 15 Pro Screen Replacement', category: 'Repair Parts', brand: 'OEM', cost: 120.00, price: 249.00, quantity: 5, has_imei: false },
];

const MOCK_REPAIRS = [
    { id: 1, ticket: 'R2025-001', customer: 'John Doe', device: 'iPhone 14', status: 'In Progress', technician: 'Jane Smith', created_at: '2025-08-20' },
    { id: 2, ticket: 'R2025-002', customer: 'Emily White', device: 'Galaxy S23', status: 'Waiting for Parts', technician: 'Jane Smith', created_at: '2025-08-19' },
    { id: 3, ticket: 'R2025-003', customer: 'Michael Brown', device: 'Pixel 7', status: 'Ready for Pickup', technician: 'Alex Chen', created_at: '2025-08-18' },
];

// --- CONTEXT for Global State ---
const AppContext = createContext();

// --- UI COMPONENTS ---

const Card = ({ children, className = '' }) => (
  <div className={`bg-white rounded-lg shadow p-4 sm:p-6 ${className}`}>
    {children}
  </div>
);

const Button = ({ children, onClick, variant = 'primary', className = '', type = 'button' }) => {
  const baseClasses = 'px-4 py-2 rounded-md font-semibold text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors duration-200';
  const variants = {
    primary: 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500',
    secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300 focus:ring-gray-400',
    danger: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500',
  };
  return (
    <button type={type} onClick={onClick} className={`${baseClasses} ${variants[variant]} ${className}`}>
      {children}
    </button>
  );
};

const Input = ({ id, label, type = 'text', placeholder, value, onChange, className = '' }) => (
    <div>
        {label && <label htmlFor={id} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
        <input
            id={id}
            type={type}
            placeholder={placeholder}
            value={value}
            onChange={onChange}
            className={`w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${className}`}
        />
    </div>
);

const Modal = ({ isOpen, onClose, title, children }) => {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onClick={onClose}>
            <div className="bg-white rounded-lg shadow-xl w-full max-w-lg" onClick={(e) => e.stopPropagation()}>
                <div className="p-4 border-b flex justify-between items-center">
                    <h2 className="text-xl font-semibold">{title}</h2>
                    <button onClick={onClose} className="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                </div>
                <div className="p-4 sm:p-6">
                    {children}
                </div>
            </div>
        </div>
    );
};


// --- LAYOUT COMPONENTS ---

const Sidebar = ({ currentPage, navigate }) => {
  const navItems = [
    { name: 'Dashboard', icon: HomeIcon, page: 'dashboard' },
    { name: 'Inventory', icon: PackageIcon, page: 'inventory' },
    { name: 'POS', icon: ShoppingCartIcon, page: 'pos' },
    { name: 'Customers', icon: UsersIcon, page: 'customers' },
    { name: 'Suppliers', icon: TruckIcon, page: 'suppliers' },
    { name: 'Repairs', icon: WrenchIcon, page: 'repairs' },
    { name: 'Reports', icon: BarChartIcon, page: 'reports' },
    { name: 'Settings', icon: SettingsIcon, page: 'settings' },
  ];

  return (
    <aside className="w-64 bg-gray-800 text-white flex-shrink-0 flex flex-col">
      <div className="h-16 flex items-center justify-center text-2xl font-bold border-b border-gray-700">
        MobileShop
      </div>
      <nav className="flex-1 px-2 py-4 space-y-1">
        {navItems.map(item => (
          <a
            key={item.name}
            href="#"
            onClick={(e) => { e.preventDefault(); navigate(item.page); }}
            className={`flex items-center px-4 py-2 text-sm rounded-md transition-colors duration-200 ${
              currentPage === item.page ? 'bg-gray-900' : 'hover:bg-gray-700'
            }`}
          >
            <item.icon className="h-5 w-5 mr-3" />
            {item.name}
          </a>
        ))}
      </nav>
    </aside>
  );
};

const Header = ({ user }) => {
  return (
    <header className="h-16 bg-white shadow-sm flex items-center justify-between px-4 sm:px-6">
      <div>
        {/* Can add breadcrumbs or page title here */}
      </div>
      <div className="flex items-center space-x-4">
        <button className="text-gray-500 hover:text-gray-700">
          <BellIcon className="h-6 w-6" />
        </button>
        <div className="flex items-center">
          <img src={user.avatarUrl} alt="User Avatar" className="h-8 w-8 rounded-full" />
          <div className="ml-3">
            <p className="text-sm font-semibold text-gray-800">{user.name}</p>
            <p className="text-xs text-gray-500">{user.role}</p>
          </div>
          <ChevronDownIcon className="h-4 w-4 ml-1 text-gray-500" />
        </div>
      </div>
    </header>
  );
};

const AppLayout = ({ children }) => {
  const { navigate, currentPage } = useContext(AppContext);
  return (
    <div className="flex h-screen bg-gray-100 font-sans">
      <Sidebar currentPage={currentPage} navigate={navigate} />
      <div className="flex-1 flex flex-col overflow-hidden">
        <Header user={MOCK_USER} />
        <main className="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 sm:p-6">
          {children}
        </main>
      </div>
    </div>
  );
};


// --- PAGE COMPONENTS ---

const Dashboard = () => {
    const { navigate, products } = useContext(AppContext);
    const stats = [
        { title: "Today's Sales", value: "$1,845.60", change: "+5.2%", changeType: 'increase' },
        { title: "Today's Profit", value: "$620.15", change: "+3.8%", changeType: 'increase' },
        { title: "Open Repairs", value: "7", change: "-1", changeType: 'decrease' },
        { title: "Low Stock Items", value: "3", change: "+2", changeType: 'increase' },
    ];

    const lowStockItems = products.filter(p => p.quantity <= 5).slice(0, 3);

    return (
        <div>
            <h1 className="text-3xl font-bold text-gray-800 mb-6">Dashboard</h1>
            
            <div className="mb-6 flex space-x-2 sm:space-x-4">
                <Button onClick={() => navigate('pos')} className="flex items-center space-x-2"><ShoppingCartIcon className="h-5 w-5"/><span>New Sale</span></Button>
                <Button onClick={() => navigate('repairs')} variant="secondary" className="flex items-center space-x-2"><WrenchIcon className="h-5 w-5"/><span>New Repair</span></Button>
                <Button onClick={() => navigate('inventory')} variant="secondary" className="flex items-center space-x-2"><PackageIcon className="h-5 w-5"/><span>Receive Stock</span></Button>
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6">
                {stats.map(stat => (
                    <Card key={stat.title}>
                        <p className="text-sm font-medium text-gray-500">{stat.title}</p>
                        <p className="text-3xl font-bold text-gray-900 mt-1">{stat.value}</p>
                    </Card>
                ))}
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
                <Card className="lg:col-span-2">
                    <h2 className="text-lg font-semibold text-gray-800 mb-4">Recent Activity</h2>
                    <p className="text-gray-600">Activity feed coming soon...</p>
                </Card>

                <Card>
                    <h2 className="text-lg font-semibold text-gray-800 mb-4">Low Stock Alerts</h2>
                    <ul className="space-y-3">
                        {lowStockItems.map(item => (
                            <li key={item.id} className="flex justify-between items-center">
                                <div>
                                    <p className="font-medium text-gray-800">{item.name}</p>
                                    <p className="text-sm text-gray-500">SKU: {item.sku}</p>
                                </div>
                                <span className="text-red-600 font-bold text-lg">{item.quantity}</span>
                            </li>
                        ))}
                    </ul>
                </Card>
            </div>
        </div>
    );
};

const POS = () => {
    const { products } = useContext(AppContext);
    const [cart, setCart] = useState([]);
    const [searchTerm, setSearchTerm] = useState('');
    const [searchResults, setSearchResults] = useState([]);
    const [paymentModalOpen, setPaymentModalOpen] = useState(false);

    useEffect(() => {
        if (searchTerm) {
            const results = products.filter(p => 
                p.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                p.sku.toLowerCase().includes(searchTerm.toLowerCase())
            );
            setSearchResults(results);
        } else {
            setSearchResults([]);
        }
    }, [searchTerm, products]);

    const addToCart = (product) => {
        const existingItem = cart.find(item => item.id === product.id);
        if (existingItem) {
            setCart(cart.map(item => item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item));
        } else {
            setCart([...cart, { ...product, quantity: 1 }]);
        }
        setSearchTerm('');
        setSearchResults([]);
    };

    const updateQuantity = (productId, newQuantity) => {
        if (newQuantity <= 0) {
            setCart(cart.filter(item => item.id !== productId));
        } else {
            setCart(cart.map(item => item.id === productId ? { ...item, quantity: newQuantity } : item));
        }
    };

    const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    const tax = subtotal * 0.08; // 8% tax
    const total = subtotal + tax;

    const handleCheckout = () => {
        if (cart.length > 0) {
            setPaymentModalOpen(true);
        } else {
            alert("Cart is empty!");
        }
    };
    
    const processPayment = () => {
        alert("Payment processed! Sale complete.");
        setCart([]);
        setPaymentModalOpen(false);
    }

    return (
        <div className="flex flex-col lg:flex-row h-full gap-4 sm:gap-6">
            <div className="lg:w-2/3 flex flex-col">
                <Card className="flex-grow flex flex-col">
                    <div className="relative mb-4">
                        <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" />
                        <Input 
                            type="text" 
                            placeholder="Search or scan product SKU..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="pl-10"
                        />
                         {searchResults.length > 0 && (
                            <ul className="absolute z-10 w-full bg-white border border-gray-200 rounded-md mt-1 shadow-lg max-h-60 overflow-y-auto">
                                {searchResults.map(product => (
                                    <li key={product.id} onClick={() => addToCart(product)} className="px-4 py-2 hover:bg-gray-100 cursor-pointer">
                                        {product.name} <span className="text-sm text-gray-500">({product.sku})</span>
                                    </li>
                                ))}
                            </ul>
                        )}
                    </div>

                    <div className="flex-grow overflow-y-auto -mx-4 sm:-mx-6 px-4 sm:px-6">
                         {cart.length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-full text-gray-500">
                                <ShoppingCartIcon className="h-16 w-16 mb-4"/>
                                <p className="text-lg">Your cart is empty</p>
                            </div>
                        ) : (
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                    <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                    <th className="px-4 py-2"></th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {cart.map(item => (
                                    <tr key={item.id}>
                                        <td className="px-4 py-2 whitespace-nowrap">{item.name}</td>
                                        <td className="px-4 py-2 whitespace-nowrap">${item.price.toFixed(2)}</td>
                                        <td className="px-4 py-2 whitespace-nowrap">
                                            <input 
                                                type="number" 
                                                value={item.quantity}
                                                onChange={(e) => updateQuantity(item.id, parseInt(e.target.value))}
                                                className="w-16 p-1 border rounded-md"
                                            />
                                        </td>
                                        <td className="px-4 py-2 whitespace-nowrap">${(item.price * item.quantity).toFixed(2)}</td>
                                        <td className="px-4 py-2 whitespace-nowrap text-right">
                                            <button onClick={() => updateQuantity(item.id, 0)} className="text-red-500 hover:text-red-700">
                                                <Trash2Icon className="h-5 w-5" />
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        )}
                    </div>
                </Card>
            </div>

            <div className="lg:w-1/3">
                <Card>
                    <h2 className="text-xl font-semibold mb-4 border-b pb-2">Order Summary</h2>
                    <div className="space-y-2 mb-4">
                        <div className="flex justify-between"><span>Subtotal</span><span>${subtotal.toFixed(2)}</span></div>
                        <div className="flex justify-between"><span>Tax (8%)</span><span>${tax.toFixed(2)}</span></div>
                        <div className="flex justify-between font-bold text-lg border-t pt-2 mt-2"><span>Total</span><span>${total.toFixed(2)}</span></div>
                    </div>
                    <Button onClick={handleCheckout} className="w-full text-lg flex items-center justify-center space-x-2">
                        <DollarSignIcon className="h-5 w-5" />
                        <span>Proceed to Payment</span>
                    </Button>
                </Card>
            </div>
            
            <Modal isOpen={paymentModalOpen} onClose={() => setPaymentModalOpen(false)} title="Complete Payment">
                <div>
                    <div className="mb-4">
                        <h3 className="text-2xl font-bold text-center">Total: ${total.toFixed(2)}</h3>
                    </div>
                    <div className="grid grid-cols-3 gap-4 mb-6">
                        <Button variant="secondary" className="py-4">Cash</Button>
                        <Button variant="secondary" className="py-4">Card</Button>
                        <Button variant="secondary" className="py-4">Transfer</Button>
                    </div>
                    <Button onClick={processPayment} className="w-full text-lg">Confirm Payment</Button>
                </div>
            </Modal>
        </div>
    );
};

const AddProductForm = ({ onAdd, onCancel }) => {
    const [product, setProduct] = useState({
        sku: '', name: '', brand: '', price: '', quantity: ''
    });

    const handleChange = (e) => {
        const { id, value } = e.target;
        setProduct(prev => ({ ...prev, [id]: value }));
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        const newProduct = {
            id: Date.now(), // Temporary unique ID
            ...product,
            price: parseFloat(product.price),
            quantity: parseInt(product.quantity),
            cost: parseFloat(product.price) * 0.7, // Mock cost
        };
        onAdd(newProduct);
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-4">
            <Input id="sku" label="SKU" value={product.sku} onChange={handleChange} placeholder="e.g., APL-IP16-BLK" />
            <Input id="name" label="Product Name" value={product.name} onChange={handleChange} placeholder="e.g., iPhone 16" />
            <Input id="brand" label="Brand" value={product.brand} onChange={handleChange} placeholder="e.g., Apple" />
            <Input id="price" label="Selling Price" type="number" value={product.price} onChange={handleChange} placeholder="e.g., 1199.00" />
            <Input id="quantity" label="Stock Quantity" type="number" value={product.quantity} onChange={handleChange} placeholder="e.g., 10" />
            <div className="flex justify-end space-x-2 pt-4">
                <Button variant="secondary" onClick={onCancel}>Cancel</Button>
                <Button type="submit">Add Product</Button>
            </div>
        </form>
    );
};

const InventoryList = () => {
    const { products, addProduct } = useContext(AppContext);
    const [isModalOpen, setIsModalOpen] = useState(false);

    const handleAddProduct = (newProduct) => {
        addProduct(newProduct);
        setIsModalOpen(false);
    };

    return (
        <div>
            <div className="flex justify-between items-center mb-6">
                <h1 className="text-3xl font-bold text-gray-800">Inventory</h1>
                <Button onClick={() => setIsModalOpen(true)}><PlusCircleIcon className="h-5 w-5 mr-2"/>Add Product</Button>
            </div>
            <Card>
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {products.map(product => (
                            <tr key={product.id}>
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{product.sku}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{product.name}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.price.toFixed(2)}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm">
                                    <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${product.quantity > 5 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                        {product.quantity}
                                    </span>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </Card>
            <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="Add New Product">
                <AddProductForm onAdd={handleAddProduct} onCancel={() => setIsModalOpen(false)} />
            </Modal>
        </div>
    );
};

const RepairTickets = () => {
    const [isModalOpen, setIsModalOpen] = useState(false);

    const RepairIntakeForm = () => {
        return (
            <form className="space-y-4">
                <Input id="customerName" label="Customer Name" placeholder="e.g., John Doe" />
                <Input id="deviceModel" label="Device Brand & Model" placeholder="e.g., Apple iPhone 14 Pro" />
                <Input id="imei" label="IMEI / Serial Number" placeholder="Enter device serial number" />
                <div>
                    <label htmlFor="problem" className="block text-sm font-medium text-gray-700">Problem Description</label>
                    <textarea id="problem" rows="3" className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Describe the issue..."></textarea>
                </div>
                <div className="flex justify-end space-x-2 pt-4">
                    <Button variant="secondary" onClick={() => setIsModalOpen(false)}>Cancel</Button>
                    <Button type="submit">Create Ticket</Button>
                </div>
            </form>
        );
    }

    return (
        <div>
            <div className="flex justify-between items-center mb-6">
                <h1 className="text-3xl font-bold text-gray-800">Repair Tickets</h1>
                <Button onClick={() => setIsModalOpen(true)}><PlusCircleIcon className="h-5 w-5 mr-2"/>New Repair Ticket</Button>
            </div>
            <Card>
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ticket #</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Device</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {MOCK_REPAIRS.map(repair => (
                            <tr key={repair.id}>
                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600 hover:underline cursor-pointer">{repair.ticket}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{repair.customer}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{repair.device}</td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm">
                                     <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                        {repair.status}
                                    </span>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </Card>
            <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="New Repair Intake">
                <RepairIntakeForm />
            </Modal>
        </div>
    );
};

const PlaceholderPage = ({ title }) => (
    <div>
        <h1 className="text-3xl font-bold text-gray-800 mb-6">{title}</h1>
        <Card>
            <p className="text-gray-600 text-center py-12">This page is under construction. Check back soon!</p>
        </Card>
    </div>
);


// --- MAIN APP COMPONENT ---

export default function App() {
  const [currentPage, setCurrentPage] = useState('dashboard');
  const [products, setProducts] = useState(INITIAL_MOCK_PRODUCTS);

  const navigate = (page) => {
    setCurrentPage(page);
  };

  const addProduct = (newProduct) => {
    setProducts(prevProducts => [...prevProducts, newProduct]);
  };

  const renderPage = () => {
    switch (currentPage) {
      case 'dashboard': return <Dashboard />;
      case 'inventory': return <InventoryList />;
      case 'pos': return <POS />;
      case 'repairs': return <RepairTickets />;
      case 'customers': return <PlaceholderPage title="Customers" />;
      case 'suppliers': return <PlaceholderPage title="Suppliers" />;
      case 'reports': return <PlaceholderPage title="Reports" />;
      case 'settings': return <PlaceholderPage title="Settings" />;
      default: return <Dashboard />;
    }
  };

  return (
    <AppContext.Provider value={{ navigate, currentPage, products, addProduct }}>
      <AppLayout>
        {renderPage()}
      </AppLayout>
    </AppContext.Provider>
  );
}
