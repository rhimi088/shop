<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Shop Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: #f1f5f9;
            --text: #1e293b;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --primary: #4f46e5;
        }
        html.dark {
            --background: #0f172a;
            --text: #e2e8f0;
            --card-bg: #1e293b;
            --border: #334155;
            --primary: #818cf8;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text);
        }
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border);
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        [data-admin-only="true"] {
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

    <!-- Auth Section -->
    <div id="auth-section" class="flex items-center justify-center h-screen">
        <div class="w-full max-w-md">
            <form id="login-form" class="card p-8 rounded-lg shadow-xl">
                <h2 class="text-2xl font-bold mb-6 text-center" data-lang-key="login">Login</h2>
                <div id="login-error" class="text-red-500 text-center mb-4 hidden"></div>
                <div class="mb-4">
                    <label class="block mb-1" for="login-email">Email</label>
                    <input class="w-full p-2 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" id="login-email" type="email" placeholder="Email" required>
                </div>
                <div class="mb-6">
                    <label class="block mb-1" for="login-password">Password</label>
                    <input class="w-full p-2 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" id="login-password" type="password" placeholder="******************" required>
                </div>
                <div class="flex items-center justify-between">
                    <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded" type="submit">Sign In</button>
                    <a id="show-register" class="inline-block align-baseline font-bold text-sm text-indigo-600 hover:text-indigo-800" href="#">Create an Account</a>
                </div>
            </form>

            <form id="register-form" class="card p-8 rounded-lg shadow-xl hidden">
                <h2 class="text-2xl font-bold mb-6 text-center" data-lang-key="register">Register</h2>
                 <div id="register-error" class="text-red-500 text-center mb-4 hidden"></div>
                <div class="mb-4">
                    <label class="block mb-1" for="register-email">Email</label>
                    <input class="w-full p-2 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" id="register-email" type="email" placeholder="Email" required>
                </div>
                <div class="mb-6">
                    <label class="block mb-1" for="register-password">Password</label>
                    <input class="w-full p-2 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" id="register-password" type="password" placeholder="******************" required>
                </div>
                <div class="flex items-center justify-between">
                    <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" type="submit">Register</button>
                    <a id="show-login" class="inline-block align-baseline font-bold text-sm text-indigo-600 hover:text-indigo-800" href="#">Already have an account?</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App Section -->
    <div id="app-section" class="hidden h-screen w-full">
        <div class="flex h-full">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-64 bg-slate-800 text-white flex-col fixed inset-y-0 left-0 z-30 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-200 ease-in-out">
                <div class="p-4 text-2xl font-bold border-b border-slate-700 text-center">
                    <span data-lang-key="app_title">Mobile Shop</span>
                </div>
                <nav class="flex-1 p-4 space-y-2">
                    <a href="#" data-section="dashboard" class="sidebar-link active flex items-center py-2 px-4 rounded-lg"><span data-lang-key="dashboard">Dashboard</span></a>
                    <a href="#" data-section="products" class="sidebar-link flex items-center py-2 px-4 rounded-lg"><span data-lang-key="products">Products</span></a>
                    <a href="#" data-section="pos" class="sidebar-link flex items-center py-2 px-4 rounded-lg"><span data-lang-key="pos">Sales Terminal</span></a>
                    <a href="#" data-section="expenses" class="sidebar-link flex items-center py-2 px-4 rounded-lg" data-admin-only="true"><span data-lang-key="expenses">Expenses</span></a>
                    <a href="#" data-section="customers" class="sidebar-link flex items-center py-2 px-4 rounded-lg"><span data-lang-key="customers">Customers</span></a>
                    <a href="#" data-section="history" class="sidebar-link flex items-center py-2 px-4 rounded-lg" data-admin-only="true"><span data-lang-key="history">Stock History</span></a>
                </nav>
                 <div class="p-4 border-t border-gray-700">
                    <div id="user-info" class="text-sm mb-2"></div>
                    <button id="logout-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Logout</button>
                </div>
            </aside>

            <div class="flex-1 flex flex-col">
                <!-- Header -->
                <header class="bg-white dark:bg-slate-800 shadow-md p-4 flex justify-between items-center">
                    <button id="menu-toggle" class="md:hidden text-slate-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h1 class="text-xl font-semibold text-slate-700 dark:text-slate-200" id="header-title" data-lang-key="dashboard">Dashboard</h1>
                    <div class="flex items-center space-x-4">
                        <button id="theme-toggle" class="text-slate-500 dark:text-slate-400">
                            <svg id="theme-icon-light" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                            <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                        </button>
                        <select id="language-switcher" class="bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-1">
                            <option value="en">English</option>
                            <option value="ps">پښتو</option>
                        </select>
                    </div>
                </header>

                <!-- Main Content -->
                <main class="flex-1 p-6 overflow-y-auto">
                    <!-- Dashboard Section -->
                    <section id="dashboard-section">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                            <div class="card p-4 rounded-lg shadow">
                                <h3 class="font-semibold" data-lang-key="sales_today">Today's Sales</h3>
                                <p class="text-2xl font-bold" id="sales-today">$0.00</p>
                            </div>
                            <div class="card p-4 rounded-lg shadow">
                                <h3 class="font-semibold" data-lang-key="profit_today">Today's Profit</h3>
                                <p class="text-2xl font-bold" id="profit-today">$0.00</p>
                            </div>
                            <div class="card p-4 rounded-lg shadow">
                                <h3 class="font-semibold" data-lang-key="expenses_today">Today's Expenses</h3>
                                <p class="text-2xl font-bold" id="expenses-today">$0.00</p>
                            </div>
                            <div class="card p-4 rounded-lg shadow">
                                <h3 class="font-semibold" data-lang-key="monthly_sales">Monthly Sales</h3>
                                <p class="text-2xl font-bold" id="monthly-sales">$0.00</p>
                            </div>
                            <div class="card p-4 rounded-lg shadow">
                                <h3 class="font-semibold" data-lang-key="monthly_profit">Monthly Profit</h3>
                                <p class="text-2xl font-bold" id="monthly-profit">$0.00</p>
                            </div>
                            <div class="card p-4 rounded-lg shadow">
                                <h3 class="font-semibold" data-lang-key="monthly_expenses">Monthly Expenses</h3>
                                <p class="text-2xl font-bold" id="monthly-expenses">$0.00</p>
                            </div>
                        </div>
                        <div class="card p-4 rounded-lg shadow mb-6">
                            <h3 class="font-semibold mb-4" data-lang-key="weekly_sales">Weekly Sales</h3>
                            <canvas id="sales-chart"></canvas>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="card p-4 rounded-lg shadow">
                                <h3 class="font-semibold mb-4" data-lang-key="top_selling">Top Selling Products</h3>
                                <ul id="top-products-list" class="space-y-2"></ul>
                            </div>
                            <div class="card p-4 rounded-lg shadow">
                                <h3 class="font-semibold mb-4 text-red-500" data-lang-key="low_stock">Low Stock Alerts</h3>
                                <ul id="low-stock-list" class="space-y-2"></ul>
                            </div>
                        </div>
                    </section>

                    <!-- Products Section -->
                    <section id="products-section" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold" data-lang-key="manage_products">Manage Products</h2>
                            <button id="add-product-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg"><span data-lang-key="add_product">Add Product</span></button>
                        </div>
                        <div class="card p-4 rounded-lg shadow overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="border-b dark:border-slate-700">
                                        <th class="p-2" data-lang-key="product_name">Name</th>
                                        <th class="p-2" data-lang-key="category">Category</th>
                                        <th class="p-2" data-lang-key="purchase_price">Purchase Price</th>
                                        <th class="p-2" data-lang-key="selling_price">Selling Price</th>
                                        <th class="p-2" data-lang-key="quantity">Quantity</th>
                                        <th class="p-2" data-lang-key="actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="products-table"></tbody>
                            </table>
                        </div>
                    </section>

                    <!-- POS Section -->
                    <section id="pos-section" class="hidden">
                         <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 card p-4 rounded-lg shadow">
                                <input type="text" id="product-search" placeholder="Search products..." class="w-full p-2 mb-4 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md">
                                <div id="product-list-pos" class="grid grid-cols-2 md:grid-cols-4 gap-4 max-h-96 overflow-y-auto"></div>
                            </div>
                            <div class="card p-4 rounded-lg shadow">
                                <h3 class="text-xl font-bold mb-4" data-lang-key="invoice">Invoice</h3>
                                <div id="invoice-items" class="space-y-2 mb-4 max-h-60 overflow-y-auto"></div>
                                <div class="border-t dark:border-slate-700 pt-4 space-y-2">
                                    <div class="flex justify-between"><span>Subtotal:</span><span id="invoice-subtotal">$0.00</span></div>
                                    <div class="flex items-center justify-between">
                                        <label for="invoice-discount">Discount ($):</label>
                                        <input type="number" id="invoice-discount" value="0" class="w-20 p-1 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-right">
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <label for="invoice-tax">Tax (%):</label>
                                        <input type="number" id="invoice-tax" value="0" class="w-20 p-1 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-right">
                                    </div>
                                    <div class="flex justify-between text-xl font-bold"><span>Total:</span><span id="invoice-total">$0.00</span></div>
                                    <button id="complete-sale-btn" class="w-full bg-green-600 text-white py-2 rounded-lg mt-4">Complete Sale</button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Expenses Section -->
                    <section id="expenses-section" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold" data-lang-key="manage_expenses">Manage Expenses</h2>
                            <button id="add-expense-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg"><span data-lang-key="add_expense">Add Expense</span></button>
                        </div>
                        <div class="card p-4 rounded-lg shadow overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="border-b dark:border-slate-700">
                                        <th class="p-2" data-lang-key="date">Date</th>
                                        <th class="p-2" data-lang-key="description">Description</th>
                                        <th class="p-2" data-lang-key="amount">Amount</th>
                                        <th class="p-2" data-lang-key="actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="expenses-table"></tbody>
                            </table>
                        </div>
                    </section>

                    <!-- Customers Section -->
                    <section id="customers-section" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold" data-lang-key="manage_customers">Manage Customers</h2>
                            <button id="add-customer-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg"><span data-lang-key="add_customer">Add Customer</span></button>
                        </div>
                        <div class="card p-4 rounded-lg shadow overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="border-b dark:border-slate-700">
                                        <th class="p-2" data-lang-key="customer_name">Name</th>
                                        <th class="p-2" data-lang-key="phone">Phone</th>
                                        <th class="p-2" data-lang-key="address">Address</th>
                                        <th class="p-2" data-lang-key="actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="customers-table"></tbody>
                            </table>
                        </div>
                    </section>

                    <!-- History Section -->
                    <section id="history-section" class="hidden">
                         <h2 class="text-2xl font-bold mb-4" data-lang-key="stock_history">Stock History</h2>
                         <div class="card p-4 rounded-lg shadow overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="border-b dark:border-slate-700">
                                        <th class="p-2" data-lang-key="date">Date</th>
                                        <th class="p-2" data-lang-key="product_name">Product</th>
                                        <th class="p-2" data-lang-key="transaction_type">Type</th>
                                        <th class="p-2" data-lang-key="quantity_change">Change</th>
                                        <th class="p-2" data-lang-key="remaining_stock">Remaining</th>
                                    </tr>
                                </thead>
                                <tbody id="history-table"></tbody>
                            </table>
                        </div>
                    </section>
                </main>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

    <!-- Product Modal -->
    <div id="product-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="card rounded-lg shadow-xl w-full max-w-md">
            <h3 id="product-modal-title" class="text-xl font-bold p-4 border-b dark:border-slate-700">Add Product</h3>
            <form id="product-form" class="p-4 space-y-4">
                <input type="hidden" id="product-id">
                <div id="product-error" class="text-red-500 text-sm mb-2 hidden"></div>
                <div>
                    <label for="product-name" class="block mb-1">Name</label>
                    <input type="text" id="product-name" class="w-full p-2 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" required>
                </div>
                <div>
                    <label for="product-category" class="block mb-1">Category</label>
                    <input type="text" id="product-category" class="w-full p-2 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="product-purchase-price" class="block mb-1">Purchase Price</label>
                        <input type="number" id="product-purchase-price" class="w-full p-2 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" required>
                    </div>
                    <div>
                        <label for="product-selling-price" class="block mb-1">Selling Price</label>
                        <input type="number" id="product-selling-price" class="w-full p-2 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="product-quantity" class="block mb-1">Quantity</label>
                        <input type="number" id="product-quantity" class="w-full p-2 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" required>
                    </div>
                    <div>
                        <label for="product-low-stock" class="block mb-1">Low Stock Level</label>
                        <input type="number" id="product-low-stock" class="w-full p-2 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" required>
                    </div>
                </div>
                <div class="flex justify-end space-x-2 pt-4 border-t dark:border-slate-700">
                    <button type="button" class="modal-cancel-btn px-4 py-2 rounded-lg">Cancel</button>
                    <button type="submit" id="save-product-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg w-24 h-10 flex items-center justify-center">
                        <span class="btn-text">Save</span>
                        <div class="loader btn-loader hidden"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expense-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
         <div class="card rounded-lg shadow-xl w-full max-w-md">
            <h3 id="expense-modal-title" class="text-xl font-bold p-4 border-b dark:border-slate-700">Add Expense</h3>
            <form id="expense-form" class="p-4 space-y-4">
                <input type="hidden" id="expense-id">
                <div id="expense-error" class="text-red-500 text-sm mb-2 hidden"></div>
                <div>
                    <label for="expense-date" class="block mb-1">Date</label>
                    <input type="date" id="expense-date" class="w-full p-2 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" required>
                </div>
                <div>
                    <label for="expense-description" class="block mb-1">Description</label>
                    <input type="text" id="expense-description" class="w-full p-2 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" required>
                </div>
                <div>
                    <label for="expense-amount" class="block mb-1">Amount</label>
                    <input type="number" id="expense-amount" class="w-full p-2 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" required>
                </div>
                <div class="flex justify-end space-x-2 pt-4 border-t dark:border-slate-700">
                    <button type="button" class="modal-cancel-btn px-4 py-2 rounded-lg">Cancel</button>
                    <button type="submit" id="save-expense-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg w-24 h-10 flex items-center justify-center">
                        <span class="btn-text">Save</span>
                        <div class="loader btn-loader hidden"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customer Modal -->
    <div id="customer-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
         <div class="card rounded-lg shadow-xl w-full max-w-md">
            <h3 id="customer-modal-title" class="text-xl font-bold p-4 border-b dark:border-slate-700">Add Customer</h3>
            <form id="customer-form" class="p-4 space-y-4">
                <input type="hidden" id="customer-id">
                 <div id="customer-error" class="text-red-500 text-sm mb-2 hidden"></div>
                <div>
                    <label for="customer-name" class="block mb-1">Name</label>
                    <input type="text" id="customer-name" class="w-full p-2 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" required>
                </div>
                <div>
                    <label for="customer-phone" class="block mb-1">Phone</label>
                    <input type="tel" id="customer-phone" class="w-full p-2 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md" required>
                </div>
                <div>
                    <label for="customer-address" class="block mb-1">Address</label>
                    <textarea id="customer-address" class="w-full p-2 bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md"></textarea>
                </div>
                <div class="flex justify-end space-x-2 pt-4 border-t dark:border-slate-700">
                    <button type="button" class="modal-cancel-btn px-4 py-2 rounded-lg">Cancel</button>
                    <button type="submit" id="save-customer-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg w-24 h-10 flex items-center justify-center">
                        <span class="btn-text">Save</span>
                        <div class="loader btn-loader hidden"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, deleteDoc, updateDoc, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDBOOTnTWqTYyWTBo8uvuJVd85399hJwOA",
            authDomain: "shop-1e233.firebaseapp.com",
            projectId: "shop-1e233",
            storageBucket: "shop-1e233.appspot.com",
            messagingSenderId: "674505750349",
            appId: "1:674505750349:web:ea131ee81b27d5b960a904",
            measurementId: "G-S65ER0NBR4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth();

        // App State
        let products = [];
        let sales = [];
        let expenses = [];
        let customers = [];
        let history = [];
        let salesChart;
        let currentUserRole = null;

        // Language Translations
        const translations = {
            en: {
                app_title: "Mobile Shop",
                dashboard: "Dashboard",
                products: "Products",
                pos: "Sales Terminal",
                expenses: "Expenses",
                customers: "Customers",
                history: "Stock History",
                sales_today: "Today's Sales",
                profit_today: "Today's Profit",
                expenses_today: "Today's Expenses",
                monthly_sales: "Monthly Sales",
                monthly_profit: "Monthly Profit",
                monthly_expenses: "Monthly Expenses",
                weekly_sales: "Weekly Sales",
                top_selling: "Top Selling Products",
                low_stock: "Low Stock Alerts",
                manage_products: "Manage Products",
                add_product: "Add Product",
                product_name: "Name",
                category: "Category",
                purchase_price: "Purchase Price",
                selling_price: "Selling Price",
                quantity: "Quantity",
                actions: "Actions",
                invoice: "Invoice",
                manage_expenses: "Manage Expenses",
                add_expense: "Add Expense",
                date: "Date",
                description: "Description",
                amount: "Amount",
                manage_customers: "Manage Customers",
                add_customer: "Add Customer",
                customer_name: "Name",
                phone: "Phone",
                address: "Address",
                stock_history: "Stock History",
                transaction_type: "Type",
                quantity_change: "Change",
                remaining_stock: "Remaining",
                login: "Login",
                register: "Register"
            },
            ps: {
                app_title: "د موبایل پلورنځی",
                dashboard: "ډشبورډ",
                products: "محصولات",
                pos: "د پلور ټرمینل",
                expenses: "لګښتونه",
                customers: "پیرودونکي",
                history: "د سټاک تاریخ",
                sales_today: "د نن ورځې پلور",
                profit_today: "د نن ورځې ګټه",
                expenses_today: "د نن ورځې لګښتونه",
                monthly_sales: "میاشتنی پلور",
                monthly_profit: "میاشتنۍ ګټه",
                monthly_expenses: "میاشتني لګښتونه",
                weekly_sales: "اوونیز پلور",
                top_selling: "غوره پلورل شوي محصولات",
                low_stock: "د کم سټاک خبرتیا",
                manage_products: "د محصولاتو اداره کول",
                add_product: "محصول اضافه کړئ",
                product_name: "نوم",
                category: "کټګوري",
                purchase_price: "د پیرود بیه",
                selling_price: "د پلور بیه",
                quantity: "مقدار",
                actions: "کړنې",
                invoice: "انوایس",
                manage_expenses: "د لګښتونو اداره کول",
                add_expense: "لګښت اضافه کړئ",
                date: "نیټه",
                description: "تفصیل",
                amount: "مقدار",
                manage_customers: "د پیرودونکو اداره کول",
                add_customer: "پیرودونکی اضافه کړئ",
                customer_name: "نوم",
                phone: "تلیفون",
                address: "پته",
                stock_history: "د سټاک تاریخ",
                transaction_type: "ډول",
                quantity_change: "بدلون",
                remaining_stock: "پاتې",
                login: "ننوتل",
                register: "راجستر"
            }
        };

        const languageSwitcher = document.getElementById('language-switcher');
        let currentLanguage = 'en';

        function setLanguage(lang) {
            currentLanguage = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ps' ? 'rtl' : 'ltr';
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            document.getElementById('header-title').textContent = translations[lang][document.querySelector('.sidebar-link.active span').dataset.langKey];
        }

        languageSwitcher.addEventListener('change', (e) => setLanguage(e.target.value));

        // Theme Toggle
        const themeToggle = document.getElementById('theme-toggle');
        const lightIcon = document.getElementById('theme-icon-light');
        const darkIcon = document.getElementById('theme-icon-dark');

        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            lightIcon.classList.toggle('hidden');
            darkIcon.classList.toggle('hidden');
        });

        // Sidebar and Navigation
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menu-toggle');
        
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('translate-x-0');
            sidebar.classList.toggle('-translate-x-full');
        });

        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                const sectionId = link.dataset.section + '-section';
                document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
                document.getElementById(sectionId).classList.remove('hidden');

                document.getElementById('header-title').textContent = link.querySelector('span').textContent;

                if (window.innerWidth < 768) {
                    sidebar.classList.add('-translate-x-full');
                    sidebar.classList.remove('translate-x-0');
                }
            });
        });

        // Modal Handling
        const modalBackdrop = document.getElementById('modal-backdrop');
        const productModal = document.getElementById('product-modal');
        const expenseModal = document.getElementById('expense-modal');
        const customerModal = document.getElementById('customer-modal');
        
        function openModal(modal) {
            modalBackdrop.classList.remove('hidden');
            modal.classList.remove('hidden');
        }

        function closeModal(modal) {
            modalBackdrop.classList.add('hidden');
            modal.classList.add('hidden');
            modal.querySelector('form').reset();
        }

        document.getElementById('add-product-btn').addEventListener('click', () => openModal(productModal));
        document.getElementById('add-expense-btn').addEventListener('click', () => openModal(expenseModal));
        document.getElementById('add-customer-btn').addEventListener('click', () => openModal(customerModal));
        
        document.querySelectorAll('.modal-cancel-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                closeModal(btn.closest('.fixed'));
            });
        });

        // Firestore Listeners
        let unsubscribers = [];
        function initializeDataListeners() {
            // Unsubscribe from old listeners
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];

            unsubscribers.push(onSnapshot(collection(db, "products"), (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }));
            unsubscribers.push(onSnapshot(collection(db, "sales"), (snapshot) => {
                sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }));
            unsubscribers.push(onSnapshot(collection(db, "expenses"), (snapshot) => {
                expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }));
            unsubscribers.push(onSnapshot(collection(db, "customers"), (snapshot) => {
                customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }));
            unsubscribers.push(onSnapshot(collection(db, "history"), (snapshot) => {
                history = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }));
        }

        function renderAll() {
            renderDashboard();
            renderProducts();
            renderExpenses();
            renderCustomers();
            renderHistory();
            renderPosProducts();
        }

        // Dashboard Rendering
        function renderDashboard() {
            const now = new Date();
            const todayStart = new Date().setHours(0, 0, 0, 0);
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

            const salesToday = sales.filter(s => new Date(s.date.seconds * 1000) >= todayStart);
            const expensesToday = expenses.filter(e => new Date(e.date) >= todayStart);
            const salesMonth = sales.filter(s => new Date(s.date.seconds * 1000) >= monthStart);
            const expensesMonth = expenses.filter(e => new Date(e.date) >= monthStart);

            const totalSalesToday = salesToday.reduce((sum, s) => sum + s.total, 0);
            const totalExpensesToday = expensesToday.reduce((sum, e) => sum + e.amount, 0);
            const profitToday = salesToday.reduce((sum, s) => sum + s.profit, 0) - totalExpensesToday;
            
            const totalSalesMonth = salesMonth.reduce((sum, s) => sum + s.total, 0);
            const totalExpensesMonth = expensesMonth.reduce((sum, e) => sum + e.amount, 0);
            const profitMonth = salesMonth.reduce((sum, s) => sum + s.profit, 0) - totalExpensesMonth;

            document.getElementById('sales-today').textContent = `$${totalSalesToday.toFixed(2)}`;
            document.getElementById('profit-today').textContent = `$${profitToday.toFixed(2)}`;
            document.getElementById('expenses-today').textContent = `$${totalExpensesToday.toFixed(2)}`;
            document.getElementById('monthly-sales').textContent = `$${totalSalesMonth.toFixed(2)}`;
            document.getElementById('monthly-profit').textContent = `$${profitMonth.toFixed(2)}`;
            document.getElementById('monthly-expenses').textContent = `$${totalExpensesMonth.toFixed(2)}`;
            
            // Weekly Sales Chart
            const weeklySalesData = Array(7).fill(0);
            const todayDay = new Date().getDay();
            sales.forEach(sale => {
                const saleDate = new Date(sale.date.seconds * 1000);
                const diffDays = Math.floor((todayStart - saleDate.setHours(0,0,0,0)) / (1000 * 60 * 60 * 24));
                if (diffDays >= 0 && diffDays < 7) {
                    weeklySalesData[(todayDay - diffDays + 7) % 7] += sale.total;
                }
            });
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const labels = Array(7).fill(0).map((_, i) => days[(todayDay - 6 + i + 7) % 7]);

            if (salesChart) salesChart.destroy();
            salesChart = new Chart(document.getElementById('sales-chart').getContext('2d'), {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Sales', data: weeklySalesData, backgroundColor: '#4f46e5' }] },
                options: { responsive: true }
            });

            // Top Selling & Low Stock
            const productSales = {};
            sales.forEach(sale => {
                sale.items.forEach(item => {
                    productSales[item.productId] = (productSales[item.productId] || 0) + item.quantity;
                });
            });
            const topProducts = Object.entries(productSales).sort((a, b) => b[1] - a[1]).slice(0, 5);
            document.getElementById('top-products-list').innerHTML = topProducts.map(([id, qty]) => {
                const product = products.find(p => p.id === id);
                return `<li>${product ? product.name : 'Unknown'} - Sold: ${qty}</li>`;
            }).join('') || '<li>No sales yet.</li>';

            const lowStockProducts = products.filter(p => p.quantity <= p.lowStockLevel);
            document.getElementById('low-stock-list').innerHTML = lowStockProducts.map(p => 
                `<li class="text-red-500">${p.name} - Remaining: ${p.quantity}</li>`
            ).join('') || '<li>No low stock items.</li>';
        }

        // Products Rendering
        function renderProducts() {
            const table = document.getElementById('products-table');
            table.innerHTML = products.map(p => `
                <tr class="border-b dark:border-slate-700">
                    <td class="p-2">${p.name}</td>
                    <td class="p-2">${p.category}</td>
                    <td class="p-2">$${p.purchasePrice.toFixed(2)}</td>
                    <td class="p-2">$${p.sellingPrice.toFixed(2)}</td>
                    <td class="p-2">${p.quantity}</td>
                    <td class="p-2">
                        <button class="edit-product-btn text-indigo-500" data-id="${p.id}">Edit</button>
                        <button class="delete-product-btn text-red-500" data-id="${p.id}">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Expenses Rendering
        function renderExpenses() {
            const table = document.getElementById('expenses-table');
            table.innerHTML = expenses.map(e => `
                <tr class="border-b dark:border-slate-700">
                    <td class="p-2">${new Date(e.date).toLocaleDateString()}</td>
                    <td class="p-2">${e.description}</td>
                    <td class="p-2">$${e.amount.toFixed(2)}</td>
                    <td class="p-2">
                        <button class="edit-expense-btn text-indigo-500" data-id="${e.id}">Edit</button>
                        <button class="delete-expense-btn text-red-500" data-id="${e.id}">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Customers Rendering
        function renderCustomers() {
             const table = document.getElementById('customers-table');
            table.innerHTML = customers.map(c => `
                <tr class="border-b dark:border-slate-700">
                    <td class="p-2">${c.name}</td>
                    <td class="p-2">${c.phone}</td>
                    <td class="p-2">${c.address}</td>
                    <td class="p-2">
                        <button class="edit-customer-btn text-indigo-500" data-id="${c.id}">Edit</button>
                        <button class="delete-customer-btn text-red-500" data-id="${c.id}">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // History Rendering
        function renderHistory() {
            const table = document.getElementById('history-table');
            table.innerHTML = history.sort((a, b) => b.date.seconds - a.date.seconds).map(h => `
                <tr class="border-b dark:border-slate-700">
                    <td class="p-2">${new Date(h.date.seconds * 1000).toLocaleString()}</td>
                    <td class="p-2">${h.productName}</td>
                    <td class="p-2">${h.type}</td>
                    <td class="p-2">${h.change}</td>
                    <td class="p-2">${h.remaining}</td>
                </tr>
            `).join('');
        }

        // POS Rendering
        function renderPosProducts() {
            const list = document.getElementById('product-list-pos');
            const searchTerm = document.getElementById('product-search').value.toLowerCase();
            list.innerHTML = products
                .filter(p => p.name.toLowerCase().includes(searchTerm) && p.quantity > 0)
                .map(p => `
                <div class="card p-2 rounded-lg text-center cursor-pointer pos-product-item" data-id="${p.id}">
                    <p class="font-semibold">${p.name}</p>
                    <p class="text-sm text-slate-500">${p.quantity} in stock</p>
                </div>
            `).join('');
        }
        
        document.getElementById('product-search').addEventListener('input', renderPosProducts);

        // Form Submissions
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('product-id').value;
            const product = {
                name: document.getElementById('product-name').value,
                category: document.getElementById('product-category').value,
                purchasePrice: parseFloat(document.getElementById('product-purchase-price').value),
                sellingPrice: parseFloat(document.getElementById('product-selling-price').value),
                quantity: parseInt(document.getElementById('product-quantity').value),
                lowStockLevel: parseInt(document.getElementById('product-low-stock').value),
            };
            if (id) {
                await setDoc(doc(db, "products", id), product);
            } else {
                await addDoc(collection(db, "products"), product);
            }
            closeModal(productModal);
        });

        document.getElementById('expense-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('expense-id').value;
            const expense = {
                date: document.getElementById('expense-date').value,
                description: document.getElementById('expense-description').value,
                amount: parseFloat(document.getElementById('expense-amount').value),
            };
            if (id) {
                await setDoc(doc(db, "expenses", id), expense);
            } else {
                await addDoc(collection(db, "expenses"), expense);
            }
            closeModal(expenseModal);
        });

        document.getElementById('customer-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('customer-id').value;
            const customer = {
                name: document.getElementById('customer-name').value,
                phone: document.getElementById('customer-phone').value,
                address: document.getElementById('customer-address').value,
            };
            if (id) {
                await setDoc(doc(db, "customers", id), customer);
            } else {
                await addDoc(collection(db, "customers"), customer);
            }
            closeModal(customerModal);
        });

        // POS Logic
        let invoiceItems = {};

        document.getElementById('product-list-pos').addEventListener('click', (e) => {
            const item = e.target.closest('.pos-product-item');
            if (item) {
                const id = item.dataset.id;
                if (invoiceItems[id]) {
                    invoiceItems[id].quantity++;
                } else {
                    const product = products.find(p => p.id === id);
                    invoiceItems[id] = { ...product, quantity: 1 };
                }
                renderInvoice();
            }
        });

        function renderInvoice() {
            const itemsDiv = document.getElementById('invoice-items');
            itemsDiv.innerHTML = Object.values(invoiceItems).map(item => `
                <div class="flex justify-between items-center">
                    <span>${item.name}</span>
                    <input type="number" value="${item.quantity}" min="1" max="${item.quantity + (products.find(p=>p.id===item.id)?.quantity || 0)}" class="w-16 p-1 text-center invoice-item-qty" data-id="${item.id}">
                    <span>$${(item.sellingPrice * item.quantity).toFixed(2)}</span>
                </div>
            `).join('');
            updateInvoiceTotal();
        }
        
        document.getElementById('invoice-items').addEventListener('change', (e) => {
            if (e.target.classList.contains('invoice-item-qty')) {
                const id = e.target.dataset.id;
                const newQty = parseInt(e.target.value);
                const product = products.find(p => p.id === id);
                if (newQty > product.quantity) {
                    e.target.value = product.quantity;
                    alert('Not enough stock!');
                } else {
                    invoiceItems[id].quantity = newQty;
                }
                renderInvoice();
            }
        });
        
        document.getElementById('invoice-discount').addEventListener('input', updateInvoiceTotal);
        document.getElementById('invoice-tax').addEventListener('input', updateInvoiceTotal);

        function updateInvoiceTotal() {
            const subtotal = Object.values(invoiceItems).reduce((sum, item) => sum + (item.sellingPrice * item.quantity), 0);
            const discount = parseFloat(document.getElementById('invoice-discount').value) || 0;
            const taxPercent = parseFloat(document.getElementById('invoice-tax').value) || 0;
            const taxAmount = (subtotal - discount) * (taxPercent / 100);
            const total = subtotal - discount + taxAmount;

            document.getElementById('invoice-subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('invoice-total').textContent = `$${total.toFixed(2)}`;
        }

        document.getElementById('complete-sale-btn').addEventListener('click', async () => {
            if (Object.keys(invoiceItems).length === 0) return;
            
            const subtotal = Object.values(invoiceItems).reduce((sum, item) => sum + (item.sellingPrice * item.quantity), 0);
            const discount = parseFloat(document.getElementById('invoice-discount').value) || 0;
            const tax = parseFloat(document.getElementById('invoice-tax').value) || 0;
            const total = subtotal - discount + ((subtotal - discount) * (tax / 100));
            const profit = Object.values(invoiceItems).reduce((sum, item) => sum + ((item.sellingPrice - item.purchasePrice) * item.quantity), 0) - discount;

            const sale = {
                date: new Date(),
                items: Object.values(invoiceItems).map(i => ({ productId: i.id, name: i.name, quantity: i.quantity, price: i.sellingPrice })),
                subtotal, discount, tax, total, profit
            };

            const batch = writeBatch(db);
            
            batch.set(doc(collection(db, "sales")), sale);

            for (const item of Object.values(invoiceItems)) {
                const productRef = doc(db, "products", item.id);
                const product = products.find(p => p.id === item.id);
                const newQuantity = product.quantity - item.quantity;
                batch.update(productRef, { quantity: newQuantity });

                const historyEntry = {
                    date: new Date(),
                    productName: item.name,
                    type: 'Sale',
                    change: -item.quantity,
                    remaining: newQuantity
                };
                batch.set(doc(collection(db, "history")), historyEntry);
            }

            await batch.commit();

            invoiceItems = {};
            renderInvoice();
            document.getElementById('invoice-discount').value = 0;
            document.getElementById('invoice-tax').value = 0;
            alert('Sale completed!');
        });

        // Authentication Logic
        const authSection = document.getElementById('auth-section');
        const appSection = document.getElementById('app-section');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');

        document.getElementById('show-register').addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
        });

        document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    loginError.textContent = error.message;
                    loginError.classList.remove('hidden');
                });
        });

        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            createUserWithEmailAndPassword(auth, email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    setDoc(doc(db, "users", user.uid), {
                        email: user.email,
                        role: "employee"
                    });
                })
                .catch(error => {
                    registerError.textContent = error.message;
                    registerError.classList.remove('hidden');
                });
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth);
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                currentUserRole = userDoc.exists() ? userDoc.data().role : 'employee';
                
                document.getElementById('user-info').textContent = `${user.email} (${currentUserRole})`;
                document.querySelectorAll('[data-admin-only]').forEach(el => {
                    el.style.display = currentUserRole === 'admin' ? '' : 'none';
                });

                authSection.classList.add('hidden');
                appSection.classList.remove('hidden');
                initializeDataListeners();
            } else {
                authSection.classList.remove('hidden');
                appSection.classList.add('hidden');
                unsubscribers.forEach(unsub => unsub());
            }
        });
    </script>
</body>
</html>
